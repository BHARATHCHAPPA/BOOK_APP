import { FastifyInstance } from 'fastify';
import { DynamoCreditRepository } from '../../infrastructure/database/DynamoCreditRepository';
import { z } from 'zod';

const creditRepo = new DynamoCreditRepository();

const purchaseCreditsSchema = z.object({
    amount: z.number().int().min(1).max(10000),
    paymentMethod: z.string().optional(), // For future payment integration
    paymentId: z.string().optional()
});

export function creditRoutes(fastify: FastifyInstance) {
    // POST /credits/purchase - Purchase credits
    fastify.post('/credits/purchase', async (req, reply) => {
        const user = (req as any).user;

        try {
            const { amount, paymentId } = purchaseCreditsSchema.parse(req.body);

            // TODO: Integrate with payment gateway (Stripe, PayPal, etc.)
            // For now, we'll simulate successful payment

            const transaction = await creditRepo.addCredits(
                user.id,
                amount,
                'purchase',
                paymentId ? `Payment ID: ${paymentId}` : 'Credit purchase'
            );

            return reply.status(201).send({
                message: 'Credits purchased successfully',
                transaction,
                newBalance: amount // In production, fetch actual balance
            });
        } catch (error: any) {
            if (error.name === 'ZodError') {
                return reply.status(400).send({ message: 'Invalid input', errors: error.errors });
            }
            if (error.name === 'CredentialsProviderError') {
                return reply.status(201).send({
                    message: 'Credits purchased successfully (dev mode)',
                    transaction: {
                        id: 'mock-transaction-id',
                        userId: user.id,
                        amount: (req.body as any).amount,
                        type: 'purchase',
                        description: 'Credit purchase',
                        createdAt: new Date().toISOString()
                    },
                    _mock: true
                });
            }
            throw error;
        }
    });

    // GET /credits/history - Get credit transaction history
    fastify.get('/credits/history', async (req, reply) => {
        const user = (req as any).user;
        const { limit } = req.query as any;

        try {
            const transactions = await creditRepo.getTransactionHistory(
                user.id,
                limit ? parseInt(limit) : 50
            );

            return reply.send(transactions);
        } catch (error: any) {
            if (error.name === 'CredentialsProviderError') {
                return reply.send([]);
            }
            throw error;
        }
    });

    // POST /credits/bonus - Add bonus credits (admin only)
    fastify.post('/credits/bonus', async (req, reply) => {
        const user = (req as any).user;

        // TODO: Add admin role check
        // if (user.role !== 'ADMIN') {
        //     return reply.status(403).send({ message: 'Admin access required' });
        // }

        const schema = z.object({
            userId: z.string(),
            amount: z.number().int().min(1),
            description: z.string()
        });

        try {
            const { userId, amount, description } = schema.parse(req.body);

            const transaction = await creditRepo.addCredits(
                userId,
                amount,
                'bonus',
                description
            );

            return reply.status(201).send({
                message: 'Bonus credits added successfully',
                transaction
            });
        } catch (error: any) {
            if (error.name === 'ZodError') {
                return reply.status(400).send({ message: 'Invalid input', errors: error.errors });
            }
            if (error.name === 'CredentialsProviderError') {
                return reply.status(201).send({
                    message: 'Bonus credits added (dev mode)',
                    _mock: true
                });
            }
            throw error;
        }
    });

    // POST /credits/refund - Refund credits (admin only)
    fastify.post('/credits/refund', async (req, reply) => {
        const schema = z.object({
            userId: z.string(),
            amount: z.number().int().min(1),
            originalTransactionId: z.string()
        });

        try {
            const { userId, amount, originalTransactionId } = schema.parse(req.body);

            const transaction = await creditRepo.refundCredits(
                userId,
                amount,
                originalTransactionId
            );

            return reply.status(201).send({
                message: 'Credits refunded successfully',
                transaction
            });
        } catch (error: any) {
            if (error.name === 'ZodError') {
                return reply.status(400).send({ message: 'Invalid input', errors: error.errors });
            }
            if (error.name === 'CredentialsProviderError') {
                return reply.status(201).send({
                    message: 'Credits refunded (dev mode)',
                    _mock: true
                });
            }
            throw error;
        }
    });
}
